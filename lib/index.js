"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.GifskiCommand=exports.gifskiPath=void 0;const tslib_1=require("tslib"),child_process_1=require("child_process"),os=tslib_1.__importStar(require("os")),path=tslib_1.__importStar(require("path")),events_1=tslib_1.__importDefault(require("events")),fs=tslib_1.__importStar(require("fs")),glob_1=require("glob"),platform=process.env.npm_config_platform||os.platform();let platformPath="";switch(platform){case"win32":platformPath=path.join("windows","gifski.exe");break;case"darwin":platformPath=path.join("macos","gifski");break;case"linux":platformPath=path.join("linux","gifski");break}if(!platformPath)throw Error(`gifski executable not found for platform ${platform}.`);let _gifskiPath=path.join(__dirname,"..","node_modules","gifski","bin",platformPath);if(fs.existsSync(_gifskiPath)||(_gifskiPath=path.join(__dirname,"..","..","..","node_modules","gifski","bin",platformPath)),!fs.existsSync(_gifskiPath))throw Error(`gifski executable not found in ${_gifskiPath}.`);exports.gifskiPath=_gifskiPath;class GifskiCommand extends events_1.default.EventEmitter{options;constructor(t){super(),this.options=t}_buildSpawnArgs(){const t=[];this.options.fps&&t.push("--fps",this.options.fps.toString()),this.options.fast&&t.push("--fast"),this.options.extra&&t.push("--extra"),this.options.quality&&t.push("--quality",this.options.quality.toString()),this.options.width&&t.push("--width",this.options.width.toString()),this.options.height&&t.push("--height",this.options.height.toString()),this.options.noSort&&t.push("--no-sort"),this.options.quiet&&t.push("--quiet"),this.options.repeat&&t.push("--repeat",this.options.repeat.toString());let s=this.options.frames;return typeof s=="string"&&(s=glob_1.glob.sync(s,{absolute:!0})),t.push("-o",this.options.output,...s),t}async run(t){t={shell:!0,...t};const s=this.options.stdoutLines??100,i=[];let u=!1;const n=[];let l=!1,d=!1,h;return new Promise((f,_)=>{const p=o=>{if(o&&(h=o),d&&u&&l){const e=i.length>0?this.options.output!=="-"?i.join(`
`):Buffer.concat(i):void 0,r=n.length>0?n.join(`
`):void 0;h&&h.message.match(/gifski exited with code/)&&r&&(h.message+=": "+r),this.emit("end",h,e,r),f({err:h,stdout:e,stderr:r})}};let a=(0,child_process_1.spawn)(`${exports.gifskiPath}`,this._buildSpawnArgs(),t);a.stdout.on("data",o=>{this.options.output!=="-"?this.options.quiet||(s!==0&&i.length===s&&i.shift(),i.push(o.toString())):i.push(o);const e=[...o.toString().trim().matchAll(/^Frame (\d+) \/ (\d+).*(\d*)s*$/g)][0];if(e){const r=parseInt(e[1]),g=parseInt(e[2]),c=e[3]?parseInt(e[3]):0,m={currentFrame:r,totalFrames:g,percent:r/g*100,secondsLeft:c};this.emit("progress",m)}}),a.stdout.on("close",()=>{u=!0,p()}),a.stderr.on("data",o=>{s!==0&&n.length===s&&n.shift(),n.push(o.toString())}),a.stderr.on("close",()=>{l=!0,p()}),a.on("error",o=>{const e=i.length>0?this.options.output!=="-"?i.join(`
`):Buffer.concat(i):void 0,r=n.length>0?n.join(`
`):void 0;this.emit("error",o,e,r)}),a.on("exit",(o,e)=>{d=!0,e?p(new Error("gifski was killed with signal "+e)):o?p(new Error("gifski exited with code "+o)):p(),a=null})})}runSync(t){t={shell:!0,stdio:"inherit",...t};const s=(0,child_process_1.spawnSync)(`${exports.gifskiPath}`,this._buildSpawnArgs(),t);let i=s.error;return s.signal&&s.signal!=="SIGTERM"?i?i.message+=`: gifski was killed with signal ${s.signal}`:i=new Error(`gifski was killed with signal ${s.signal}`):s.status&&(i?i.message+=`: gifski exited with code ${s.status}`:i=new Error(`gifski exited with code ${s.status}`)),{err:i,stdout:s.stdout,stderr:s.stderr}}}exports.GifskiCommand=GifskiCommand;